# デバッグ機能
## Universal Monitor
- [Universal Monitor](https://electrelic.com/electrelic/node/1317)が既にIM6100に対応していたため，それをベースにしてControl Panel空間(CP空間)で動くように改変しました．
- CP空間ではindirect addressingによるメモリアクセスはメインメモリ空間(MM空間)へのアクセスとなるため，文字列バッファ等へのアクセスがCP空間になるようにするための修正を行いました．[tools/unimon](../tools/unimon)が修正後のソースです．
- コンテキスト(PC, AC, LINK, IF, DF)の保存と復帰を実装したので，Gで元のプログラムを続行できるはず．

### 使い方
- CPREQ スイッチを押すとCP割り込みによって起動します．PCはCP空間の0番地に保存されます．

### コマンド
- オリジナルのコマンドD, S, L, Gと、追加のコマンドR, F, Wが実装されています．
- D, S, L: MM空間に対する読み書きです．
- G: CP割り込み状態を終了してMM空間に戻ります．引数が無い場合は0番地に保存されているアドレスに復帰します．AC, LINK, IF, DFには1〜2番地に保存された値がロードされます．
- R (Register): ACを設定します．G実行時にACに代入されます．
- F (Flag and Field): フラグ(Link), IF, DF値を設定します．DFは即時，IFはG実行時に代入されます．入力&表示される値は8進数の
```
<LINK,0,IREQ> <IIF,IEFF,0> <IF><DF>
```
なので，意味があるのはMSBのLINKと，下2桁目のIF, DFです．

- W (sWitch): Switch Register (OSR命令で読まれる値)を設定します．
  - 物理的なパネルスイッチが無いので，FPGA上にレジスタを用意して実装しました．
- R, F, Rとも引数が無いときは現在の値を表示します．

### 注意事項
- CP割り込み中はHALT-FFの状態に関わらず常にRUN状態です．GしてMM空間に戻ったときに，HALT-FFが立っているためにRUNにならずにHALTしていることがよくあります．その場合はCONTスイッチを押してRUNにします．

## デバッグログ
- DBG_UARTにログを出力します．
- top.vの `define USE_ACCESSLOG を有効にすると使えます．(無効化したことがないので無効化してちゃんとビルドできるかどうかは不明)
- 詳細はtop.vを見て下さい．

### disk accessログ
- ディスクの読み書きがあった際のレジスタ値などを出力しています．

OS/8ブート時のログの例
```
時刻(ms),R/W, PC, Cmd reg., word cnt, mem addr, disk addr, drive No.
5542:RK rd,000027,000000,000400,000000,000000,000000
5558:RK rd,007671,000000,000400,000000,000007,000000
5563:RK rd,007671,001000,000400,000400,000010,000000
5567:RK rd,007671,001000,000400,001000,000011,000000
5572:RK rd,007671,001000,000400,001400,000012,000000
```

### 命令実行ログ
- HALT時やステップ実行時に最後に実行した命令やメモリアクセスを表示します．
- dbg_mode(クロックを1kHzに落としてRUN状態でも表示するモード)を実装しました．TangNanoのSW2でトグルします．
```
時刻(ms), mnem, PC, inst, read addr, data, write addr, data
8992:JMP I,007777,005776,007776,005000,000000,000000
9024:JMS I,005000,004652,007000,000000,007000,005001
9058:KCC  ,007001,006032,006032,000000,006032,000000
9078:CLA  ,007002,007200,000000,000000,000000,000000
9108:JMP I,007003,005600,007000,005001,000000,000000
9128:CLA  ,005001,007200,000000,000000,000000,000000
9148:TAD  ,005002,001253,005053,000000,000000,000000
9170:DCA0 ,005003,003140,000140,000000,000140,000000
9190:TAD  ,005004,001253,005053,000000,000000,000000
9212:DCA0 ,005005,003142,000142,000000,000142,000000
9232:TAD  ,005006,001253,005053,000000,000000,000000
9254:DCA0 ,005007,003143,000143,000000,000143,000000

```

## [tools/sample](../tools/sample)
- bootloaderやテストプログラムです．
- universal monitorのSコマンドで書いて実行します．
